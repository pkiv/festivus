<!doctype html>
<html>
  <head>
    <title>Festivus, rejoice!</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
      #login, #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="login">
        <h1>Please login to fetch artists</h1>
        <button id="login-button" class="btn btn-primary">Log in with Spotify</button>
      </div>
      <div id="loggedin">
        <div id="user-profile">
        </div>
        <div id="oauth">
        </div>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
      <h1>Artists you follow who are going to be at Coachella!</h1>
      {{#each this}}
        <li>{{this}}</li>
      {{/each}}
    </script>

    <script id="oauth-template" type="text/x-handlebars-template">
      <h2>oAuth info</h2>
      <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
      </dl>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      (function() {
        var stateKey = 'spotify_auth_state';
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
         Array.prototype.contains = function ( needle ) {
           for (i in this) {
               if (this[i] == needle) return true;
             }
             return false;
          }
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        function initialCall() {
            $.ajax({
                url: 'https://api.spotify.com/v1/me/following?type=artist&limit=50',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  console.log(response);
                  for (var i = 0; i < response.artists.items.length; i++) {
                      if(lineUp.indexOf(response.artists.items[i].name) >= 0){

                          matches.push(response.artists.items[i].name);
                      }
                  }
                  if (response.artists.next != null){
                      subsequentCall(response.artists.next);
                  } else {
                    console.log(matches);
                    userProfilePlaceholder.innerHTML = userProfileTemplate(matches);
                    $('#login').hide();
                    $('#loggedin').show();
                  }
                }
            });
        }

        function subsequentCall(aUrl){
          $.ajax({
                url: aUrl,
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  console.log(response);
                  for (var i = 0; i < response.artists.items.length; i++) {
                      if(lineUp.indexOf(response.artists.items[i].name) >= 0){
                          matches.push(response.artists.items[i].name);
                      }
                  }
                  if (response.artists.next != null){
                      subsequentCall(response.artists.next);
                  } else {
                    console.log(matches);
                    userProfilePlaceholder.innerHTML = userProfileTemplate(matches);
                    $('#login').hide();
                    $('#loggedin').show();
                  }
                }
            });
        }

        /**
         * Generates a random string containing numbers and letters
         * @param  {number} length The length of the string
         * @return {string} The generated string
         */
        function generateRandomString(length) {
          var text = '';
          var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
          for (var i = 0; i < length; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
          }
          return text;
        };
        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');
            oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');
        var params = getHashParams();
        var access_token = params.access_token,
            state = params.state,
            storedState = localStorage.getItem(stateKey);
        var matches = [];
        var lineUp = ["LCD Soundsystem", "Ellie Goulding", "Sufjan Stevens", "Jack Ü", "M83", "Underworld", "The Kills", "Foals", "Of Monsters And Men", "G-Eazy", "Purity Ring", "Rae Sremmurd", "Volbeat", "2manydjs", "Lord Huron", "St Germain", "Savages", "The Last Shadow Puppets", "Joey Bada$$", "DJ Mustard", "BØRNS", "Christine And The Queens", "Snakehips", "Robert DeLong", "Bob Moses", "Ibeyi", "Marco Carola", "Parov Stelar", "Black Coffee", "Years & Years", "Nicole Moudaber & Skin", "Lido", "HEALTH", "Mavis Staples", "Sasha", "Goldroom", "Carla Morrison", "Nic Fanciulli", "The Front Bottoms", "Skepta", "Sam Feldt", "Lemaitre", "Louis The Child", "Frances", "George FitzGerald", "DJ EZ", "Gallant", "HÆLOS", "Låpsley", "Miami Horror", "SG Lewis", "Sheer MaG", "Mbongwana Star", "Nina Las Vegas", "Nora En Pure", "Masha", "Guns N’ Roses", "Ice Cube", "Disclosure", "Zedd", "A$AP Rocky", "CHVRCHES", "Halsey", "James Bay", "Grimes", "Courtney Barnett", "Run The Jewels", "The Arcs", "RL Grime", "Gary Clark Jr.", "Silversun Pickups", "Lush", "ZHU", "Deerhunter", "Unknown Mortal Orchestra", "Rhye", "Bat For Lashes", "The Damned", "Vince Staples", "Tchami", "Nina Kraviz", "Snails", "RÜFÜS DU SOL", "Lost Frequencies", "Chronixx", "Vanic", "Justin Martin", "AlunaGeorge", "Mano Le Tough", "Shamir", "DJ Koze", "BADBADNOTGOOD", "Moon Taxi", "SZA", "Ex Hex", "Mr. Carmack", "SOPHIE", "Protjoe", "Alvvays", "Zella Day", "Dubfire", "Matthew Dear", "DMA’s", "Matoma", "Algiers", "GoGo Penguin", "The Black Madonna", "Cloves", "Strangers You Know", "Amine Edge & DANCE", "Phases", "The Dead Ships", "Calvin Harris", "Sia", "Major Lazer", "Flume", "Beach House", "The 1975", "Rancid", "Miike Snow", "Edward Sharpe And The Magnetic Zeros", "Matt And Kim", "Chris Stapleton", "Cold War Kids", "Death Grips", "The Chainsmokers", "Maceo Plex", "Baauer", "KSHMR", "Nathaniel Rateliff & The Night Sweats", "Adam Beyer & Ida Engberg", "Wolf Alice", "Pete Yorn", "Hudson Mohawke", "Kamasi Washington", "Claptone", "TOKiMONSTA", "Melody’s Echo Chamber", "Autolux", "John Digweed", "Thomas Jack", "Anderson .Paak", "Nosaj Thing", "Deafheaven", "Epik High", "Tensnake", "Alessia Cara", "Crystal Fighters", "The Vandals", "Joywave", "PRAYERS", "Young Fathers", "The Heavy", "Tei Shi", "Meg Meyers", "Soul Clap", "Cassy", "De Lux", "Girlpool", "Fur Coat", "AC Slater"];
        if (access_token && (state == null || state !== storedState)) {
          alert('There was an error during the authentication');
        } else {
          localStorage.removeItem(stateKey);
          if (access_token) {
            initialCall();
          } else {
              $('#login').show();
              $('#loggedin').hide();
          }
          document.getElementById('login-button').addEventListener('click', function() {
            var client_id = 'INSERT KEY HERE *** HELLO ** KEY'; // Your client id
            var redirect_uri = 'http://localhost:8888/'; // Your redirect uri
            var state = generateRandomString(16);
            localStorage.setItem(stateKey, state);
            var scope = 'user-read-private user-follow-read';
            var url = 'https://accounts.spotify.com/authorize';
            url += '?response_type=token';
            url += '&client_id=' + encodeURIComponent(client_id);
            url += '&scope=' + encodeURIComponent(scope);
            url += '&redirect_uri=' + encodeURIComponent(redirect_uri);
            url += '&state=' + encodeURIComponent(state);
            window.location = url;
          }, false);
        }
      })();
    </script>
</html>
