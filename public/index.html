<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Festivus, rejoice!</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/2-col-portfolio.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style type="text/css">
      #login {
        width: 50%;
        margin: 0 auto;
    }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
    </style>

</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Festivus</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="http://paulklein.works/">About</a>
                    </li>
                    <li>
                        <a href="http://paulklein.works/">Contact</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>
    <div id="login">
                <h1>First things first, please login to fetch Artists!</h1>
                <button id="login-button" class="btn btn-primary">Log in with Spotify</button>
              </div>
    <!-- Page Content -->
    <div class="container" id="loggedin">

        <!-- Page Header -->
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">Coachella artists you follow on Spotify.
                    <small>You have great taste!</small>
                </h1>
            </div>
            
        </div>
        <!-- /.row -->

        <!-- Projects Row -->
        <div id="data">
        </div>

        <script id="bands" type="text/x-handlebars-template">
        <ul>
        {{#each objects}}
        <div class="col-md-6 portfolio-item">
                <a href="{{external_urls.spotify}}">
                    <img class="img-responsive" src="{{images.0.url}}" alt="">
                </a>
                <h3>
                    <a href="{{external_urls.spotify}}"> {{name}} </a>
                </h3>
            </div>
        {{/each}}
        </script>
        <!-- /.row -->
        <hr>

        <!-- Footer -->
        <footer>
            <div class="row">
                <div class="col-lg-12">
                    <p>Copyright &copy; Paul Klein 2016</p>
                </div>
            </div>
            <!-- /.row -->
        </footer>

    </div>
    <!-- /.container -->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

</body>
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <!--<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script> -->
    <script>
      (function() {
        var stateKey = 'spotify_auth_state';
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
         Array.prototype.contains = function ( needle ) {
           for (i in this) {
               if (this[i] == needle) return true;
             }
             return false;
          }
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        function initialCall() {
            $.ajax({
                url: 'https://api.spotify.com/v1/me/following?type=artist&limit=50',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  for (var i = 0; i < response.artists.items.length; i++) {
                      if(lineUp.indexOf(response.artists.items[i].name) >= 0){

                          matches.push(response.artists.items[i]);
                      }
                  }
                  if (response.artists.next != null){
                      subsequentCall(response.artists.next);
                  } else {
                    $("#data").append(bandsTemplate({objects:matches})) ;
                    $('#login').hide();
                    $('#loggedin').show();
                  }
                }
            });
        }

        function subsequentCall(aUrl){
          $.ajax({
                url: aUrl,
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  for (var i = 0; i < response.artists.items.length; i++) {
                      if(lineUp.indexOf(response.artists.items[i].name) >= 0){
                          matches.push(response.artists.items[i]);
                      }
                  }
                  if (response.artists.next != null){
                      subsequentCall(response.artists.next);
                  } else {
                    $("#data").append(bandsTemplate({objects:matches})) ;
                    $('#login').hide();
                    $('#loggedin').show();
                  }
                }
            });
        }

        /**
         * Generates a random string containing numbers and letters
         * @param  {number} length The length of the string
         * @return {string} The generated string
         */
        function generateRandomString(length) {
          var text = '';
          var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
          for (var i = 0; i < length; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
          }
          return text;
        };

        var bandsSource = $("#bands").html();
          bandsTemplate = Handlebars.compile (bandsSource),
          placeholder = $("#data").html();
        var params = getHashParams();
        var access_token = params.access_token,
            state = params.state,
            storedState = localStorage.getItem(stateKey);
        var matches = [];
        var lineUp = ["LCD Soundsystem", "Ellie Goulding", "Sufjan Stevens", "Jack Ü", "M83", "Underworld", "The Kills", "Foals", "Of Monsters And Men", "G-Eazy", "Purity Ring", "Rae Sremmurd", "Volbeat", "2manydjs", "Lord Huron", "St Germain", "Savages", "The Last Shadow Puppets", "Joey Bada$$", "DJ Mustard", "BØRNS", "Christine And The Queens", "Snakehips", "Robert DeLong", "Bob Moses", "Ibeyi", "Marco Carola", "Parov Stelar", "Black Coffee", "Years & Years", "Nicole Moudaber & Skin", "Lido", "HEALTH", "Mavis Staples", "Sasha", "Goldroom", "Carla Morrison", "Nic Fanciulli", "The Front Bottoms", "Skepta", "Sam Feldt", "Lemaitre", "Louis The Child", "Frances", "George FitzGerald", "DJ EZ", "Gallant", "HÆLOS", "Låpsley", "Miami Horror", "SG Lewis", "Sheer MaG", "Mbongwana Star", "Nina Las Vegas", "Nora En Pure", "Masha", "Guns N’ Roses", "Ice Cube", "Disclosure", "Zedd", "A$AP Rocky", "CHVRCHES", "Halsey", "James Bay", "Grimes", "Courtney Barnett", "Run The Jewels", "The Arcs", "RL Grime", "Gary Clark Jr.", "Silversun Pickups", "Lush", "ZHU", "Deerhunter", "Unknown Mortal Orchestra", "Rhye", "Bat For Lashes", "The Damned", "Vince Staples", "Tchami", "Nina Kraviz", "Snails", "RÜFÜS DU SOL", "Lost Frequencies", "Chronixx", "Vanic", "Justin Martin", "AlunaGeorge", "Mano Le Tough", "Shamir", "DJ Koze", "BADBADNOTGOOD", "Moon Taxi", "SZA", "Ex Hex", "Mr. Carmack", "SOPHIE", "Protjoe", "Alvvays", "Zella Day", "Dubfire", "Matthew Dear", "DMA’s", "Matoma", "Algiers", "GoGo Penguin", "The Black Madonna", "Cloves", "Strangers You Know", "Amine Edge & DANCE", "Phases", "The Dead Ships", "Calvin Harris", "Sia", "Major Lazer", "Flume", "Beach House", "The 1975", "Rancid", "Miike Snow", "Edward Sharpe And The Magnetic Zeros", "Matt And Kim", "Chris Stapleton", "Cold War Kids", "Death Grips", "The Chainsmokers", "Maceo Plex", "Baauer", "KSHMR", "Nathaniel Rateliff & The Night Sweats", "Adam Beyer & Ida Engberg", "Wolf Alice", "Pete Yorn", "Hudson Mohawke", "Kamasi Washington", "Claptone", "TOKiMONSTA", "Melody’s Echo Chamber", "Autolux", "John Digweed", "Thomas Jack", "Anderson .Paak", "Nosaj Thing", "Deafheaven", "Epik High", "Tensnake", "Alessia Cara", "Crystal Fighters", "The Vandals", "Joywave", "PRAYERS", "Young Fathers", "The Heavy", "Tei Shi", "Meg Meyers", "Soul Clap", "Cassy", "De Lux", "Girlpool", "Fur Coat", "AC Slater"];
        if (access_token && (state == null || state !== storedState)) {
          alert('There was an error during the authentication');
        } else {
          localStorage.removeItem(stateKey);
          if (access_token) {
            initialCall();
          } else {
              $('#login').show();
              $('#loggedin').hide();
          }
          document.getElementById('login-button').addEventListener('click', function() {
            var client_id = 'INSERT API KEY HERE'; // Your client id
            var redirect_uri = 'http://localhost:8888/'; // Your redirect uri
            var state = generateRandomString(16);
            localStorage.setItem(stateKey, state);
            var scope = 'user-read-private user-follow-read';
            var url = 'https://accounts.spotify.com/authorize';
            url += '?response_type=token';
            url += '&client_id=' + encodeURIComponent(client_id);
            url += '&scope=' + encodeURIComponent(scope);
            url += '&redirect_uri=' + encodeURIComponent(redirect_uri);
            url += '&state=' + encodeURIComponent(state);
            window.location = url;
          }, false);
        }
      })();
    </script>
</html>
